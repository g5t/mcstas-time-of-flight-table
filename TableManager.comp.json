{"name":"Comp","obj":{"name":"TableManager","category":"UNKNOWN","define":[],"setting":[{"name":"filename","value":{"expr":[{"_value":"\"tof_table.dat\"","_data":3,"_object":1,"_shape":1}]},"unit":null,"description":null},{"name":"max_events","value":{"expr":[{"_value":1000000,"_data":2,"_object":1,"_shape":1}]},"unit":null,"description":null}],"output":[],"metadata":[],"dependency":null,"acc":true,"share":[{"filename":"/home/runner/work/mcstas-time-of-flight-table/mcstas-time-of-flight-table/TableManager.comp","line":46,"source":"\n#ifndef _TOF_TABLE_SHARED\n#define _TOF_TABLE_SHARED\n\n/* Forward declaration of the particle-variable accessor generated by mccode-antlr.\n * The definition appears later in the same translation unit (visit_macros section),\n * so a forward declaration is sufficient for calling it from INITIALIZE. */\nextern void* _get_particle_var(char *token, _class_particle *p);\n\n/* Byte offsets from the start of _class_particle to the tof_t / tof_n fields.\n * Set by TableManager INITIALIZE; used by all three component types in TRACE. */\nstatic ptrdiff_t _tof_t_offset = -1;\nstatic ptrdiff_t _tof_n_offset = -1;\n\n/* Running count of TableRecorder instances, incremented by each one in INITIALIZE. */\nstatic int _tof_recorder_count = 0;\n\n/* Convenience macros: dereference tof_t / tof_n for a given particle pointer.\n * Only valid after TableManager INITIALIZE has set the offsets. */\n#define _TOF_T_PTR(particle) (*(double**)((char*)(particle) + _tof_t_offset))\n#define _TOF_N_PTR(particle) (*(int*)  ((char*)(particle) + _tof_n_offset))\n\n#endif /* _TOF_TABLE_SHARED */\n","translated":null}],"user":[{"filename":"/home/runner/work/mcstas-time-of-flight-table/mcstas-time-of-flight-table/TableManager.comp","line":72,"source":"\n  /* Per-particle dynamic array of recorded times and its allocated size.\n   * These fields are inserted into every neutron ray's state struct.\n   * NOTE: the generated C code appends an instance-index suffix, e.g. tof_t_5.\n   *       TableManager's INITIALIZE locates those fields by name and stores\n   *       their byte offsets so that TableSetup and TableRecorder can use\n   *       the _TOF_T_PTR / _TOF_N_PTR macros to access the same storage. */\n  double* tof_t;\n  int tof_n;\n","translated":null}],"declare":[{"filename":"/home/runner/work/mcstas-time-of-flight-table/mcstas-time-of-flight-table/TableManager.comp","line":84,"source":"\n  double* _table_data;      /* flat 2D buffer: row = event, cols = [t[0]..t[n-1], weight] */\n  int     _table_n_recorders;\n  long    _table_n_events;\n  long    _table_max_events;\n","translated":null}],"initialize":[{"filename":"/home/runner/work/mcstas-time-of-flight-table/mcstas-time-of-flight-table/TableManager.comp","line":92,"source":"\n  /* Locate the per-particle USERVARS for this component instance.\n   * mccode-antlr names them  tof_t_<index>  and  tof_n_<index>  where\n   * <index> == INDEX_CURRENT_COMP (the 1-based position of this component). */\n  {\n    _class_particle _dummy;\n    memset(&_dummy, 0, sizeof(_class_particle));\n    char _fname[64];\n\n    snprintf(_fname, sizeof(_fname), \"tof_t_%d\", INDEX_CURRENT_COMP);\n    void* _tp = _get_particle_var(_fname, &_dummy);\n    if (!_tp) {\n      fprintf(stderr,\n        \"TableManager ERROR: USERVAR '%s' not found in _class_particle.\\n\"\n        \"  Check that this TableManager instance is correctly placed and that\\n\"\n        \"  no other component has already defined tof_t / tof_n USERVARS.\\n\",\n        _fname);\n      exit(1);\n    }\n    _tof_t_offset = (char*)_tp - (char*)&_dummy;\n\n    snprintf(_fname, sizeof(_fname), \"tof_n_%d\", INDEX_CURRENT_COMP);\n    void* _np = _get_particle_var(_fname, &_dummy);\n    if (!_np) {\n      fprintf(stderr, \"TableManager ERROR: USERVAR '%s' not found.\\n\", _fname);\n      exit(1);\n    }\n    _tof_n_offset = (char*)_np - (char*)&_dummy;\n  }\n\n  _table_n_recorders = _tof_recorder_count;\n  _table_max_events  = max_events;\n  _table_n_events    = 0;\n\n  if (_table_n_recorders <= 0) {\n    fprintf(stderr,\n      \"TableManager WARNING: No TableRecorder components found \"\n      \"(or none were initialised before TableManager).\\n\");\n    _table_data = NULL;\n  } else {\n    /* Allocate: n_recorders time columns + 1 weight column, per event */\n    _table_data = (double*)calloc(\n      (long)_table_max_events * (_table_n_recorders + 1), sizeof(double));\n    if (!_table_data) {\n      fprintf(stderr, \"TableManager ERROR: Failed to allocate output table.\\n\");\n      exit(1);\n    }\n  }\n","translated":null}],"trace":[{"filename":"/home/runner/work/mcstas-time-of-flight-table/mcstas-time-of-flight-table/TableManager.comp","line":143,"source":"\n  if (_tof_t_offset >= 0 && _tof_n_offset >= 0) {\n    double* _tof_arr = _TOF_T_PTR(_particle);\n    int     _tof_n  = _TOF_N_PTR(_particle);\n\n    if (_table_data && _tof_arr && _tof_n > 0) {\n      #pragma omp critical\n      {\n        if (_table_n_events < _table_max_events) {\n          long _base = _table_n_events * (_table_n_recorders + 1);\n          int  _nc   = _tof_n < _table_n_recorders ? _tof_n : _table_n_recorders;\n          int  _i;\n          for (_i = 0; _i < _nc; _i++) {\n            _table_data[_base + _i] = _tof_arr[_i];\n          }\n          _table_data[_base + _table_n_recorders] = p;\n          _table_n_events++;\n        }\n      }\n    }\n\n    /* Deallocate per-particle array and reset counter */\n    if (_tof_arr) {\n      free(_tof_arr);\n      _TOF_T_PTR(_particle) = NULL;\n    }\n    _TOF_N_PTR(_particle) = 0;\n  }\n","translated":null}],"save":[{"filename":"/home/runner/work/mcstas-time-of-flight-table/mcstas-time-of-flight-table/TableManager.comp","line":174,"source":"\n  if (_table_data && _table_n_events > 0 && _table_n_recorders > 0) {\n    FILE* _f = fopen(filename, \"w\");\n    if (_f) {\n      int _j;\n      fprintf(_f, \"#\");\n      for (_j = 0; _j < _table_n_recorders; _j++)\n        fprintf(_f, \" t[%d]\", _j);\n      fprintf(_f, \" weight\\n\");\n\n      long _i;\n      for (_i = 0; _i < _table_n_events; _i++) {\n        long _base = _i * (_table_n_recorders + 1);\n        for (_j = 0; _j <= _table_n_recorders; _j++) {\n          if (_j > 0) fprintf(_f, \" \");\n          fprintf(_f, \"%.15g\", _table_data[_base + _j]);\n        }\n        fprintf(_f, \"\\n\");\n      }\n      fclose(_f);\n    } else {\n      fprintf(stderr, \"TableManager WARNING: Could not open '%s' for writing.\\n\", filename);\n    }\n  }\n","translated":null}],"final":[{"filename":"/home/runner/work/mcstas-time-of-flight-table/mcstas-time-of-flight-table/TableManager.comp","line":201,"source":"\n  if (_table_data) {\n    free(_table_data);\n    _table_data = NULL;\n  }\n","translated":null}],"display":[]}}
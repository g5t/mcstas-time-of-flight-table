{"name":"Comp","obj":{"name":"TableSetup","category":"UNKNOWN","define":[],"setting":[],"output":[],"metadata":[],"dependency":null,"acc":true,"share":[{"filename":"/home/runner/work/mcstas-time-of-flight-table/mcstas-time-of-flight-table/TableSetup.comp","line":32,"source":"\n#ifndef _TOF_TABLE_SHARED\n#define _TOF_TABLE_SHARED\n\nextern void* _get_particle_var(char *token, _class_particle *p);\n\nstatic ptrdiff_t _tof_t_offset = -1;\nstatic ptrdiff_t _tof_n_offset = -1;\n\nstatic int _tof_recorder_count = 0;\n\n#define _TOF_T_PTR(particle) (*(double**)((char*)(particle) + _tof_t_offset))\n#define _TOF_N_PTR(particle) (*(int*)  ((char*)(particle) + _tof_n_offset))\n\n#endif /* _TOF_TABLE_SHARED */\n","translated":null}],"user":[],"declare":[{"filename":"/home/runner/work/mcstas-time-of-flight-table/mcstas-time-of-flight-table/TableSetup.comp","line":50,"source":"\n  /* Number of TableRecorder components in the instrument.\n   * Set on the first TRACE call (after all INITIALIZE sections have run). */\n  int n_recorders;\n","translated":null}],"initialize":[{"filename":"/home/runner/work/mcstas-time-of-flight-table/mcstas-time-of-flight-table/TableSetup.comp","line":57,"source":"\n  /* At this point TableRecorder components may not yet have initialised and\n   * incremented _tof_recorder_count (INITIALIZE order = instrument file order).\n   * The count is therefore read on the first TRACE call once all INITIALIZE\n   * sections have completed. */\n  n_recorders = 0;\n","translated":null}],"trace":[{"filename":"/home/runner/work/mcstas-time-of-flight-table/mcstas-time-of-flight-table/TableSetup.comp","line":66,"source":"\n  if (_tof_t_offset < 0 || _tof_n_offset < 0) {\n    /* TableManager has not initialised the offsets yet â€“ this should not\n     * happen at TRACE time, but guard against it defensively. */\n    fprintf(stderr,\n      \"TableSetup ERROR: particle-USERVAR offsets are not set. \"\n      \"Ensure TableManager appears in the instrument and is placed after \"\n      \"TableSetup and all TableRecorder components.\\n\");\n    ABSORB;\n  }\n\n  /* Lazily read the recorder count on the first call. By TRACE time all\n   * INITIALIZE sections have completed, so _tof_recorder_count is final. */\n  if (!n_recorders)\n    n_recorders = _tof_recorder_count;\n\n  if (n_recorders <= 0) {\n    /* Nothing to record; leave tof_t NULL and tof_n = 0. */\n  } else {\n    /* Allocate and zero-initialise the per-particle time array. */\n    double* _arr = (double*)calloc(n_recorders, sizeof(double));\n    if (!_arr) {\n      fprintf(stderr, \"TableSetup ERROR: calloc failed for %d doubles.\\n\",\n              n_recorders);\n      ABSORB;\n    }\n    _TOF_T_PTR(_particle) = _arr;\n    _TOF_N_PTR(_particle) = n_recorders;\n  }\n","translated":null}],"save":[],"final":[],"display":[]}}